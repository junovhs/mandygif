export component RegionSelector inherits Window {
    width: 3840px;
    height: 2160px;
    always-on-top: true;
    no-frame: true;
    
    in-out property <length> sel-x: 0px;
    in-out property <length> sel-y: 0px;
    in-out property <length> sel-width: 3840px;
    in-out property <length> sel-height: 2160px;
    in-out property <string> locked-aspect: "";  // "16:9", "4:3", "1:1", "21:9", ""
    property <bool> editing-width: false;
    property <bool> editing-height: false;
    property <string> width-input: "1280";
    property <string> height-input: "720";
    
    callback confirm();
    callback cancel();
    
    background: transparent;
    
    // Helper to apply aspect ratio immediately
    function apply-aspect-ratio(ratio: string) {
        if (ratio == "16:9") {
            sel-height = sel-width * 9 / 16;
        } else if (ratio == "4:3") {
            sel-height = sel-width * 3 / 4;
        } else if (ratio == "1:1") {
            sel-height = sel-width;
        } else if (ratio == "21:9") {
            sel-height = sel-width * 9 / 21;
        }
    }
    
    // Selection box
    Rectangle {
        x: sel-x;
        y: sel-y;
        width: sel-width;
        height: sel-height;
        
        // Colored semi-transparent overlay inside frame
        Rectangle {
            width: parent.width;
            height: parent.height;
            background: #BBF4510F;
            border-width: 1px;
            border-color: #69F451;
        }
        
        // Top bar
        Rectangle {
            y: -40px;
            width: parent.width;
            height: 40px;
            background: #1a1a1a;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            
            // Width input (absolute positioned)
            width-edit := TouchArea {
                x: 8px;
                y: 8px;
                width: 50px;
                height: 24px;
                z: 10;
                
                Rectangle {
                    background: width-edit.has-hover ? #2a2a2a : transparent;
                    border-radius: 3px;
                    border-width: root.editing-width ? 1px : 0px;
                    border-color: #69F451;
                    
                    if !root.editing-width: Text {
                        text: round(sel-width / 1px);
                        color: width-edit.has-hover ? #69F451 : white;
                        font-size: 14px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    if root.editing-width: TextInput {
                        text <=> root.width-input;
                        color: #69F451;
                        font-size: 14px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        
                        accepted => {
                            sel-width = max(200px, self.text.to-float() * 1px);
                            if (locked-aspect != "") {
                                root.apply-aspect-ratio(locked-aspect);
                            }
                            root.editing-width = false;
                        }
                    }
                }
                
                clicked => {
                    root.editing-height = false;
                    root.width-input = round(sel-width / 1px);
                    root.editing-width = true;
                }
            }
            
            // Ã— separator
            Text {
                x: 62px;
                y: 8px;
                text: "Ã—";
                color: #666;
                font-size: 14px;
                vertical-alignment: center;
            }
            
            // Height input (absolute positioned)
            height-edit := TouchArea {
                x: 74px;
                y: 8px;
                width: 50px;
                height: 24px;
                z: 10;
                
                Rectangle {
                    background: height-edit.has-hover ? #2a2a2a : transparent;
                    border-radius: 3px;
                    border-width: root.editing-height ? 1px : 0px;
                    border-color: #69F451;
                    
                    if !root.editing-height: Text {
                        text: round(sel-height / 1px);
                        color: height-edit.has-hover ? #69F451 : white;
                        font-size: 14px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    if root.editing-height: TextInput {
                        text <=> root.height-input;
                        color: #69F451;
                        font-size: 14px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        
                        accepted => {
                            sel-height = max(100px, self.text.to-float() * 1px);
                            if (locked-aspect != "") {
                                root.apply-aspect-ratio(locked-aspect);
                            }
                            root.editing-height = false;
                        }
                    }
                }
                
                clicked => {
                    root.editing-width = false;
                    root.height-input = round(sel-height / 1px);
                    root.editing-height = true;
                }
            }
            
            // Divider line
            Rectangle {
                x: 132px;
                y: 12px;
                width: 1px;
                height: 16px;
                background: #444;
            }
            
            // Aspect ratio buttons (absolute positioned)
            aspect-16-9 := TouchArea {
                x: 145px;
                y: 8px;
                width: 50px;
                height: 24px;
                z: 10;
                
                Rectangle {
                    width: parent.width;
                    height: parent.height;
                    background: aspect-16-9.pressed ? #3a3a3a : (locked-aspect == "16:9" ? #69F45133 : (aspect-16-9.has-hover ? #2a2a2a : transparent));
                    border-radius: 4px;
                    border-width: locked-aspect == "16:9" ? 1px : 0px;
                    border-color: #69F451;
                    
                    Text {
                        text: locked-aspect == "16:9" ? "ðŸ”’ 16:9" : "16:9";
                        color: locked-aspect == "16:9" ? #69F451 : (aspect-16-9.has-hover ? #69F451 : #ccc);
                        font-size: 13px;
                        font-weight: 600;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                clicked => {
                    if (locked-aspect == "16:9") {
                        locked-aspect = "";
                    } else {
                        locked-aspect = "16:9";
                        root.apply-aspect-ratio("16:9");
                    }
                }
            }
            
            aspect-4-3 := TouchArea {
                x: 203px;
                y: 8px;
                width: 45px;
                height: 24px;
                z: 10;
                
                Rectangle {
                    width: parent.width;
                    height: parent.height;
                    background: aspect-4-3.pressed ? #3a3a3a : (locked-aspect == "4:3" ? #69F45133 : (aspect-4-3.has-hover ? #2a2a2a : transparent));
                    border-radius: 4px;
                    border-width: locked-aspect == "4:3" ? 1px : 0px;
                    border-color: #69F451;
                    
                    Text {
                        text: locked-aspect == "4:3" ? "ðŸ”’ 4:3" : "4:3";
                        color: locked-aspect == "4:3" ? #69F451 : (aspect-4-3.has-hover ? #69F451 : #ccc);
                        font-size: 13px;
                        font-weight: 600;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                clicked => {
                    if (locked-aspect == "4:3") {
                        locked-aspect = "";
                    } else {
                        locked-aspect = "4:3";
                        root.apply-aspect-ratio("4:3");
                    }
                }
            }
            
            aspect-1-1 := TouchArea {
                x: 256px;
                y: 8px;
                width: 40px;
                height: 24px;
                z: 10;
                
                Rectangle {
                    width: parent.width;
                    height: parent.height;
                    background: aspect-1-1.pressed ? #3a3a3a : (locked-aspect == "1:1" ? #69F45133 : (aspect-1-1.has-hover ? #2a2a2a : transparent));
                    border-radius: 4px;
                    border-width: locked-aspect == "1:1" ? 1px : 0px;
                    border-color: #69F451;
                    
                    Text {
                        text: locked-aspect == "1:1" ? "ðŸ”’ 1:1" : "1:1";
                        color: locked-aspect == "1:1" ? #69F451 : (aspect-1-1.has-hover ? #69F451 : #ccc);
                        font-size: 13px;
                        font-weight: 600;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                clicked => {
                    if (locked-aspect == "1:1") {
                        locked-aspect = "";
                    } else {
                        locked-aspect = "1:1";
                        root.apply-aspect-ratio("1:1");
                    }
                }
            }
            
            aspect-21-9 := TouchArea {
                x: 304px;
                y: 8px;
                width: 50px;
                height: 24px;
                z: 10;
                
                Rectangle {
                    width: parent.width;
                    height: parent.height;
                    background: aspect-21-9.pressed ? #3a3a3a : (locked-aspect == "21:9" ? #69F45133 : (aspect-21-9.has-hover ? #2a2a2a : transparent));
                    border-radius: 4px;
                    border-width: locked-aspect == "21:9" ? 1px : 0px;
                    border-color: #69F451;
                    
                    Text {
                        text: locked-aspect == "21:9" ? "ðŸ”’ 21:9" : "21:9";
                        color: locked-aspect == "21:9" ? #69F451 : (aspect-21-9.has-hover ? #69F451 : #ccc);
                        font-size: 13px;
                        font-weight: 600;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                clicked => {
                    if (locked-aspect == "21:9") {
                        locked-aspect = "";
                    } else {
                        locked-aspect = "21:9";
                        root.apply-aspect-ratio("21:9");
                    }
                }
            }
            
            // Close button (absolute positioned top-right)
            Rectangle {
                x: parent.width - 32px;
                y: 8px;
                width: 24px;
                height: 24px;
                background: #cc0000;
                border-radius: 4px;
                z: 10;
                
                Text {
                    text: "âœ•";
                    color: white;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
                
                TouchArea {
                    width: parent.width;
                    height: parent.height;
                    clicked => { root.cancel(); }
                }
            }
            
            // Drag to move entire window
            TouchArea {
                x: 0;
                y: 0;
                width: parent.width;
                height: parent.height;
                z: -1;
                
                property <length> offset-x;
                property <length> offset-y;
                
                pointer-event(event) => {
                    if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                        self.offset-x = self.mouse-x;
                        self.offset-y = self.mouse-y;
                    }
                }
                
                moved => {
                    if (self.pressed) {
                        sel-x += self.mouse-x - self.offset-x;
                        sel-y += self.mouse-y - self.offset-y;
                    }
                }
            }
        }
        
        // Bottom bar
        Rectangle {
            y: parent.height;
            width: parent.width;
            height: 50px;
            background: #1a1a1a;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            
            HorizontalLayout {
                padding: 10px;
                spacing: 10px;
                alignment: center;
                
                // Record button
                Rectangle {
                    width: 60px;
                    height: 30px;
                    background: #ff0000;
                    border-radius: 15px;
                    
                    Text {
                        text: "REC";
                        color: white;
                        font-weight: 700;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        clicked => { root.confirm(); }
                    }
                }
            }
        }
        
        // Bottom-right resize handle
        Rectangle {
            x: parent.width - 30px;
            y: parent.height + 10px;
            width: 24px;
            height: 30px;
            
            Image {
                source: @image-url("assets/6dots.svg");
                width: 48px;
                height: 96px;
                x: -12px;
                y: -33px;
                image-fit: contain;
                colorize: #888;
            }
            
            TouchArea {
                width: parent.width;
                height: parent.height;
                
                property <length> drag-start-x;
                property <length> drag-start-y;
                property <length> start-width;
                property <length> start-height;
                
                pointer-event(event) => {
                    if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                        self.drag-start-x = self.mouse-x;
                        self.drag-start-y = self.mouse-y;
                        self.start-width = sel-width;
                        self.start-height = sel-height;
                    }
                }
                
                moved => {
                    if (self.pressed) {
                        self.start-width = max(200px, self.start-width + (self.mouse-x - self.drag-start-x));
                        self.start-height = max(100px, self.start-height + (self.mouse-y - self.drag-start-y));
                        
                        if (locked-aspect == "16:9") {
                            sel-width = self.start-width;
                            sel-height = sel-width * 9 / 16;
                        } else if (locked-aspect == "4:3") {
                            sel-width = self.start-width;
                            sel-height = sel-width * 3 / 4;
                        } else if (locked-aspect == "1:1") {
                            sel-width = self.start-width;
                            sel-height = sel-width;
                        } else if (locked-aspect == "21:9") {
                            sel-width = self.start-width;
                            sel-height = sel-width * 9 / 21;
                        } else {
                            sel-width = self.start-width;
                            sel-height = self.start-height;
                        }
                    }
                }
            }
        }
    }
}